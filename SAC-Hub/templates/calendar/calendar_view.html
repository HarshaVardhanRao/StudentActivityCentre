{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Calendar - SAC Hub{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row max-w-[1400px] mx-auto my-8 gap-6">

    <!-- Calendar Section -->
    <div class="lg:w-3/4">
        <div class="bg-gradient-to-r from-gray-100 via-gray-200 to-gray-100 border-2 border-gray-300 rounded-2xl shadow-lg p-6">
            <!-- Month Navigation -->
            <div class="flex items-center justify-between mb-4">
                <a href="?month={{ prev_month.month }}&year={{ prev_month.year }}" 
                   class="px-4 py-2 border-2 border-gray-300 rounded-md hover:bg-blue-600 hover:text-white transition">
                    <i class="bi bi-chevron-left"></i> Previous
                </a>
                <h2 class="text-2xl font-bold text-gray-800">{{ current_month|date:"F Y" }}</h2>
                <a href="?month={{ next_month.month }}&year={{ next_month.year }}" 
                   class="px-4 py-2 border-2 border-gray-300 rounded-md hover:bg-blue-600 hover:text-white transition">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            </div>

            <!-- Legend and Total Events -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex items-center gap-2 text-gray-600 font-semibold">
                        <div class="w-6 h-6 rounded-sm bg-gradient-to-r from-yellow-400 to-green-400 border-2 border-yellow-400"></div>
                        Today
                    </div>
                    <div class="flex items-center gap-2 text-gray-600 font-semibold">
                        <div class="w-6 h-6 rounded-sm bg-purple-500 border-2 border-purple-500"></div>
                        Events
                    </div>
                </div>
                <span class="px-3 py-1 rounded-md font-semibold text-white bg-blue-600">
                    {{ total_events_this_month }} events this month
                </span>
            </div>

            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-2 text-center">
                <!-- Weekday Headers -->
                <div class="bg-blue-600 text-white font-bold py-2 rounded-md">Sun</div>
                <div class="bg-blue-600 text-white font-bold py-2 rounded-md">Mon</div>
                <div class="bg-blue-600 text-white font-bold py-2 rounded-md">Tue</div>
                <div class="bg-blue-600 text-white font-bold py-2 rounded-md">Wed</div>
                <div class="bg-blue-600 text-white font-bold py-2 rounded-md">Thu</div>
                <div class="bg-blue-600 text-white font-bold py-2 rounded-md">Fri</div>
                <div class="bg-blue-600 text-white font-bold py-2 rounded-md">Sat</div>


                <!-- Calendar Days -->
                {% for week in calendar_weeks %}
                    {% for day in week %}
                        <div class="relative min-h-[120px] p-2 border-2 rounded-lg transition transform
                            {% if day.is_other_month %}bg-gray-100 text-gray-400 cursor-default opacity-50{% else %}bg-white hover:scale-105 hover:shadow-lg cursor-pointer{% endif %}
                            {% if day.is_today %}bg-gradient-to-r from-yellow-400 to-green-400 text-white font-bold border-4 border-yellow-400 animate-pulse{% endif %}
                            {% if day.events %}border-l-4 border-purple-500{% endif %}">
                            
                            <!-- Day Number -->
                            <div class="font-semibold mb-1">{{ day.day }}</div>

                            <!-- Events -->
                            {% for event in day.events %}
                                <div class="bg-purple-500 text-white text-xs font-semibold rounded px-1 py-[1px] mb-1 truncate cursor-pointer hover:bg-purple-700"
                                     title="{{ event.name }} - {{ event.date_time|time:'g:i A' }}"
                                     onclick="window.location.href='{% url 'event_detail' event.id %}'">
                                    {{ event.name|truncatechars:15 }}
                                    {% if user.is_authenticated and event.user_registered %}
                                        <i class="bi bi-check-circle-fill text-green-400"></i>
                                    {% endif %}
                                </div>
                            {% endfor %}

                            {% if day.events|length > 3 %}
                                <div class="bg-gray-200 text-gray-600 text-xs font-semibold rounded px-1 py-[1px] cursor-pointer hover:bg-gray-300"
                                     onclick="showDayEvents('{{ year }}-{{ month }}-{{ day.day }}')">
                                    +{{ day.events|length|add:"-3" }} more
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>

            <!-- Quick Actions -->
            <div class="mt-6 flex flex-wrap gap-4 justify-center">
                {% if user|has_role:"FACULTY" or user|has_role:"CLUB_ADVISOR" or user|has_role:"CLUB_COORDINATOR" or user|has_role:"ADMIN" or user|has_role:"SAC_COORDINATOR" %}
                    <a href="{% url 'event_create' %}" 
                       class="px-4 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition">
                        <i class="bi bi-plus-circle"></i> Create New Event
                    </a>
                {% endif %}
                <a href="{% url 'event_list' %}" 
                   class="px-4 py-2 border-2 border-blue-600 text-blue-600 rounded-md hover:bg-blue-600 hover:text-white transition">
                    <i class="bi bi-list"></i> View All Events
                </a>
                <button type="button" onclick="window.print()" 
                        class="px-4 py-2 border-2 border-gray-400 text-gray-700 rounded-md hover:bg-gray-400 hover:text-white transition">
                    <i class="bi bi-printer"></i> Print Calendar
                </button>
            </div>
        </div>
    </div>

    <!-- Upcoming Events Sidebar -->
    <div class="lg:w-1/4">
        <div class="bg-white border-2 border-gray-300 rounded-2xl shadow-lg">
            <div class="bg-gradient-to-r from-blue-600 to-purple-500 text-white rounded-t-2xl p-4 font-semibold flex items-center gap-2">
                <i class="bi bi-calendar-plus"></i> Upcoming Events
            </div>
            <div class="p-4 max-h-[600px] overflow-y-auto">
                {% if upcoming_events %}
                    {% for event in upcoming_events %}
                        <div class="border-l-4 border-purple-500 bg-gray-50 p-3 mb-4 rounded-md hover:bg-white hover:border-blue-600 transition cursor-pointer">
                            <h6 class="font-semibold mb-1">
                                <a href="{% url 'event_detail' event.id %}" class="hover:underline">
                                    {{ event.name }}
                                </a>
                            </h6>
                            <small class="text-gray-500">{{ event.club.name }}</small>
                            <br>
                            <small class="text-gray-500"><i class="bi bi-calendar"></i> {{ event.date_time|date:"M d, g:i A" }}</small>
                            <br>
                            <small class="text-gray-500"><i class="bi bi-geo-alt"></i> {{ event.venue }}</small>
                            {% if user.is_authenticated %}
                                <br>
                                <small class="text-gray-500"><i class="bi bi-people"></i> {{ event.registration_count|default:0 }} registered
                                    {% if event.user_registered %}
                                        <span class="bg-green-500 text-white px-2 py-0.5 rounded text-xs ml-1">You're registered</span>
                                    {% endif %}
                                </small>
                            {% endif %}

                            {% if user.is_authenticated and not event.user_registered %}
                                <div class="mt-2">
                                    <a href="{% url 'event_register' event.id %}" 
                                       class="px-2 py-1 border border-green-500 text-green-500 rounded-md text-xs hover:bg-green-500 hover:text-white transition">
                                        <i class="bi bi-person-plus"></i> Register
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4 text-gray-400">
                        <i class="bi bi-calendar-x text-3xl"></i>
                        <p class="mt-2">No upcoming events</p>
                    </div>
                {% endif %}

                {% if not user.is_authenticated %}
                    <div class="mt-4 p-3 bg-gray-100 rounded-md text-center">
                        <p class="text-sm font-semibold mb-1">Want to register for events?</p>
                        <p class="text-xs text-gray-600 mb-2">Log in to register for events and receive updates.</p>
                        <a href="{% url 'login' %}" 
                           class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition">
                            <i class="bi bi-box-arrow-in-right"></i> Login
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showDayEvents(date) {
    window.location.href = `/events/?date=${date}`;
}
</script>
{% endblock %}
