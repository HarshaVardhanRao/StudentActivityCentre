{% extends 'base.html' %}

{% block title %}Send Notification - SAC Hub{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-send"></i> Send Notification
                    </h4>
                </div>
                
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" id="notificationForm">
                        {% csrf_token %}
                        
                        <!-- Recipient Type Selection -->
                        <div class="mb-4">
                            <label for="recipientType" class="form-label fw-bold">Send To</label>
                            <select name="recipient_type" id="recipientType" class="form-select" required onchange="updateScopeOptions()">
                                <option value="">-- Select Recipients --</option>
                                {% for value, label in recipient_options %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Select who you want to send this notification to
                            </small>
                        </div>

                        <!-- Scope Selection (for specific clubs/departments) -->
                        <div class="mb-4" id="scopeContainer" style="display: none;">
                            <label for="scopeValue" class="form-label fw-bold">Select Specific</label>

                            <!-- Single-selection fallback (for older roles / compatibility) -->
                            <select name="scope_value" id="scopeValue" class="form-select" style="display: none;">
                                <option value="">-- Choose --</option>
                            </select>

                            <!-- Multi-select for clubs -->
                            <select name="clubs" id="clubsSelect" class="form-select" multiple style="display: none; height: 200px;">
                                <!-- Options populated by JavaScript -->
                            </select>

                            <!-- Multi-select for departments -->
                            <select name="departments" id="deptsSelect" class="form-select" multiple style="display: none; height: 200px;">
                                <!-- Options populated by JavaScript -->
                            </select>

                            <small class="form-text text-muted mt-1">Use Ctrl / Cmd to select multiple items.</small>
                        </div>

                        <!-- Message Text Area -->
                        <div class="mb-4">
                            <label for="message" class="form-label fw-bold">Message</label>
                            <textarea 
                                name="message" 
                                id="message" 
                                class="form-control" 
                                rows="5" 
                                placeholder="Enter your notification message (max 500 characters)"
                                maxlength="500"
                                required></textarea>
                            <small class="form-text text-muted">
                                <span id="charCount">0</span>/500 characters
                            </small>
                        </div>

                        <!-- Important flag -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" value="1" id="importantFlag" name="important">
                            <label class="form-check-label" for="importantFlag">
                                Mark as important
                            </label>
                        </div>

                        <!-- Recipient Preview -->
                        <div class="alert alert-info d-none" id="recipientPreview">
                            <small class="d-block mb-2"><strong>Recipients Preview:</strong></small>
                            <small id="previewText">No recipients selected</small>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send-fill"></i> Send Notification
                            </button>
                            <a href="{% url 'notifications_list' %}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Helper Info Box -->
            <div class="card mt-4 bg-light">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-info-circle"></i> About Your Role Permissions
                    </h6>
                    <small class="text-muted d-block">
                        {% if "ADMIN" in user.roles or "SAC_COORDINATOR" in user.roles %}
                            <strong>As an Admin/SAC Coordinator:</strong> You can send notifications to all users, specific groups, or individual clubs/departments.
                        {% elif "CLUB_COORDINATOR" in user.roles %}
                            <strong>As a Club Coordinator:</strong> You can send notifications to members of your coordinated clubs and their faculty advisors.
                        {% elif "CLUB_ADVISOR" in user.roles %}
                            <strong>As a Club Advisor:</strong> You can send notifications to members of the clubs you advise.
                        {% elif "DEPARTMENT_ADMIN" in user.roles or "DEPARTMENT_VP" in user.roles or "EVENT_ORGANIZER" in user.roles %}
                            <strong>As a Department Admin/VP/Event Organizer:</strong> You can send notifications to students in your department or all students.
                        {% elif "PRESIDENT" in user.roles or "SVP" in user.roles %}
                            <strong>As President/SVP:</strong> You can send notifications to all students, all users, or specific clubs/departments.
                        {% elif "SECRETARY" in user.roles or "TREASURER" in user.roles %}
                            <strong>As Secretary/Treasurer:</strong> You can send notifications to all users or all students.
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data for JavaScript -->
<script>
    const clubsData = {{ clubs|safe }};
    const departmentsData = {{ departments|safe }};
    const userRole = '{{ user_role }}';
    const coordinatedClubs = {{ coordinated_clubs|default:"[]"|safe }};
    const advisedClubs = {{ advised_clubs|default:"[]"|safe }};
    const userDepartment = {{ user_department|default:"null"|safe }};
    const allowMultiClub = {{ allow_multi_club_select|default:False|yesno:"true,false" }};
    const allowMultiDept = {{ allow_multi_dept_select|default:False|yesno:"true,false" }};

    // Update character count
    document.getElementById('message').addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length;
    });

    // Update scope options based on recipient type
    function updateScopeOptions() {
        const recipientType = document.getElementById('recipientType').value;
        const scopeContainer = document.getElementById('scopeContainer');
        const scopeSelect = document.getElementById('scopeValue');
        const clubsSelect = document.getElementById('clubsSelect');
        const deptsSelect = document.getElementById('deptsSelect');

        // Reset all
        scopeSelect.style.display = 'none';
        clubsSelect.style.display = 'none';
        deptsSelect.style.display = 'none';
        scopeContainer.style.display = 'none';

        clubsSelect.innerHTML = '';
        deptsSelect.innerHTML = '';
        scopeSelect.innerHTML = '<option value="">-- Choose --</option>';

        if (recipientType === 'specific_club') {
            scopeContainer.style.display = 'block';
            // If multi-select allowed, show multi-select with limited options (coordinator/advisor vs admin)
            if (allowMultiClub) {
                clubsSelect.style.display = 'block';
                // If coordinator/advisor, show only their clubs
                if (coordinatedClubs && coordinatedClubs.length > 0) {
                    coordinatedClubs.forEach(c => {
                        const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; clubsSelect.appendChild(opt);
                    });
                } else if (advisedClubs && advisedClubs.length > 0) {
                    advisedClubs.forEach(c => {
                        const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; clubsSelect.appendChild(opt);
                    });
                } else {
                    // Admin/President case: show all clubs
                    clubsData.forEach(club => { const opt = document.createElement('option'); opt.value = club.id; opt.textContent = club.name; clubsSelect.appendChild(opt); });
                }
            } else {
                // Single select fallback
                scopeSelect.style.display = 'block';
                clubsData.forEach(club => {
                    const option = document.createElement('option'); option.value = club.id; option.textContent = club.name; scopeSelect.appendChild(option);
                });
            }
        } else if (recipientType === 'specific_department') {
            scopeContainer.style.display = 'block';
            if (allowMultiDept) {
                deptsSelect.style.display = 'block';
                departmentsData.forEach(dept => { const opt = document.createElement('option'); opt.value = dept.id; opt.textContent = dept.name; deptsSelect.appendChild(opt); });
            } else {
                scopeSelect.style.display = 'block';
                departmentsData.forEach(dept => { const option = document.createElement('option'); option.value = dept.id; option.textContent = dept.name; scopeSelect.appendChild(option); });
            }
        }
    }

    // Form submission validation
    document.getElementById('notificationForm').addEventListener('submit', function(e) {
        const recipientType = document.getElementById('recipientType').value;
        const message = document.getElementById('message').value.trim();
        
        if (!recipientType) {
            e.preventDefault();
            alert('Please select recipients');
            return false;
        }
        
        if (!message) {
            e.preventDefault();
            alert('Please enter a message');
            return false;
        }

        if (recipientType === 'specific_club') {
            const clubsSel = document.getElementById('clubsSelect');
            const scopeSel = document.getElementById('scopeValue');
            if ((clubsSel && clubsSel.style.display !== 'none' && clubsSel.selectedOptions.length === 0) && (scopeSel && scopeSel.style.display !== 'none' && !scopeSel.value)) {
                e.preventDefault();
                alert('Please select at least one club');
                return false;
            }
        }
        if (recipientType === 'specific_department') {
            const deptsSel = document.getElementById('deptsSelect');
            const scopeSel = document.getElementById('scopeValue');
            if ((deptsSel && deptsSel.style.display !== 'none' && deptsSel.selectedOptions.length === 0) && (scopeSel && scopeSel.style.display !== 'none' && !scopeSel.value)) {
                e.preventDefault();
                alert('Please select at least one department');
                return false;
            }
        }

        // Confirm before sending
        return confirm('Send notification to selected recipients?');
    });
</script>

    <!-- Select2 CDN and initialization for nicer multi-select UI -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        (function(){
            // Initialize Select2 on multi-select elements when they are present
            function initSelect2() {
                if (document.getElementById('clubsSelect')) {
                    $('#clubsSelect').select2({placeholder: 'Select club(s)', width: '100%'});
                }
                if (document.getElementById('deptsSelect')) {
                    $('#deptsSelect').select2({placeholder: 'Select department(s)', width: '100%'});
                }
                if (document.getElementById('scopeValue')) {
                    $('#scopeValue').select2({placeholder: '-- Choose --', minimumResultsForSearch: Infinity, width: '100%'});
                }
            }

            // Call init after a small timeout to ensure DOM updates from updateScopeOptions
            document.getElementById('recipientType').addEventListener('change', function(){
                setTimeout(initSelect2, 50);
            });

            // Init now in case elements are present
            setTimeout(initSelect2, 100);
        })();
    </script>

{% endblock %}
