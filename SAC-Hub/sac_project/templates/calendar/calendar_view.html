{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Calendar - SAC Hub{% endblock %}

{% block extra_css %}
<style>
    .calendar-container { max-width: 1200px; margin: 0 auto; }
    .calendar-header { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #dee2e6; }
    .calendar-cell { background: white; min-height: 120px; padding: 8px; position: relative; }
    .calendar-cell.other-month { background: #f8f9fa; color: #6c757d; }
    .calendar-cell.today { background: #e3f2fd; }
    .calendar-cell.has-events { border-left: 4px solid #007bff; }
    .day-number { font-weight: bold; margin-bottom: 4px; }
    .event-item { font-size: 0.75rem; margin-bottom: 2px; padding: 2px 4px; border-radius: 3px; cursor: pointer; }
    .event-club { background: #d4edda; color: #155724; }
    .event-department { background: #fff3cd; color: #856404; }
    .event-national { background: #f8d7da; color: #721c24; }
    .month-nav { display: flex; align-items: center; justify-content: space-between; }
    .legend { display: flex; gap: 1rem; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 0.5rem; }
    .legend-color { width: 20px; height: 20px; border-radius: 3px; }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <div class="month-nav">
            <div>
                <a href="?month={{ prev_month.month }}&year={{ prev_month.year }}" class="btn btn-outline-primary">
                    <i class="bi bi-chevron-left"></i> Previous
                </a>
            </div>
            <h2>{{ current_month|date:"F Y" }}</h2>
            <div>
                <a href="?month={{ next_month.month }}&year={{ next_month.year }}" class="btn btn-outline-primary">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color event-club"></div>
                    <span>Club Events</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color event-department"></div>
                    <span>Department Events</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color event-national"></div>
                    <span>National Days</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <!-- Weekday Headers -->
        <div class="calendar-cell text-center fw-bold bg-primary text-white">Sun</div>
        <div class="calendar-cell text-center fw-bold bg-primary text-white">Mon</div>
        <div class="calendar-cell text-center fw-bold bg-primary text-white">Tue</div>
        <div class="calendar-cell text-center fw-bold bg-primary text-white">Wed</div>
        <div class="calendar-cell text-center fw-bold bg-primary text-white">Thu</div>
        <div class="calendar-cell text-center fw-bold bg-primary text-white">Fri</div>
        <div class="calendar-cell text-center fw-bold bg-primary text-white">Sat</div>

        <!-- Calendar Days -->
        {% for week in calendar_weeks %}
            {% for day in week %}
                <div class="calendar-cell 
                    {% if day.is_other_month %}other-month{% endif %}
                    {% if day.is_today %}today{% endif %}
                    {% if day.events %}has-events{% endif %}">
                    
                    <div class="day-number">{{ day.day }}</div>
                    
                    {% for event in day.events %}
                        <div class="event-item 
                            {% if event.entry_type == 'CLUB_EVENT' %}event-club
                            {% elif event.entry_type == 'DEPARTMENT_EVENT' %}event-department
                            {% else %}event-national{% endif %}"
                             title="{{ event.event.name }} - {{ event.event.date_time|time:'g:i A' }}"
                             onclick="showEventDetails({{ event.event.id }})">
                            {{ event.event.name|truncatechars:20 }}
                        </div>
                    {% endfor %}
                    
                    {% if day.events|length > 3 %}
                        <div class="event-item" style="background: #e9ecef; color: #6c757d;">
                            +{{ day.events|length|add:"-3" }} more
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endfor %}
    </div>

    <!-- Quick Actions -->
    <div class="mt-4 text-center">
        {% if user|has_role:"FACULTY" or user|has_role:"CLUB_ADVISOR" or user|has_role:"CLUB_COORDINATOR" or user|has_role:"ADMIN" or user|has_role:"SAC_COORDINATOR" %}
            <a href="{% url 'event_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create New Event
            </a>
        {% endif %}
        <a href="{% url 'event_list' %}" class="btn btn-outline-primary">
            <i class="bi bi-list"></i> View All Events
        </a>
        <button type="button" class="btn btn-outline-secondary" onclick="exportCalendar()">
            <i class="bi bi-download"></i> Export Calendar
        </button>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="eventModalLink" class="btn btn-primary">View Full Details</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showEventDetails(eventId) {
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    
    // Show modal with loading state
    document.getElementById('eventModalBody').innerHTML = 'Loading...';
    modal.show();
    
    // Fetch event details
    fetch(`/api/events/${eventId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('eventModalTitle').textContent = data.name;
            document.getElementById('eventModalBody').innerHTML = `
                <p><strong>Club:</strong> ${data.club.name}</p>
                <p><strong>Date & Time:</strong> ${new Date(data.date_time).toLocaleString()}</p>
                <p><strong>Venue:</strong> ${data.venue}</p>
                <p><strong>Type:</strong> ${data.event_type}</p>
                <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(data.status)}">${data.status}</span></p>
                ${data.description ? `<p><strong>Description:</strong> ${data.description}</p>` : ''}
            `;
            document.getElementById('eventModalLink').href = `/events/${eventId}/`;
        })
        .catch(error => {
            document.getElementById('eventModalBody').innerHTML = 'Error loading event details.';
        });
}

function getStatusColor(status) {
    switch(status) {
        case 'APPROVED': return 'success';
        case 'PENDING': return 'warning';
        case 'REJECTED': return 'danger';
        case 'COMPLETED': return 'info';
        default: return 'secondary';
    }
}

function exportCalendar() {
    const month = new URLSearchParams(window.location.search).get('month') || new Date().getMonth() + 1;
    const year = new URLSearchParams(window.location.search).get('year') || new Date().getFullYear();
    window.location.href = `/calendar/export/?month=${month}&year=${year}`;
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        document.querySelector('.month-nav a').click();
    } else if (e.key === 'ArrowRight') {
        document.querySelector('.month-nav a:last-child').click();
    }
});
</script>
{% endblock %}