{% extends 'base.html' %}

{% block title %}Attendance - {{ event.name }} - SAC Hub{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Attendance Management</h2>
        <h5 class="text-muted">{{ event.name }}</h5>
        <p class="text-muted">{{ event.date_time|date:"M d, Y" }} at {{ event.venue }}</p>
    </div>
    <div>
        <button type="button" class="btn btn-success" onclick="markAllPresent()">Mark All Present</button>
        <button type="button" class="btn btn-warning" onclick="markAllAbsent()">Mark All Absent</button>
    </div>
</div>

<!-- Attendance Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <h3 id="present-count">{{ attendance_stats.present }}</h3>
                <p>Present</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-danger text-white">
            <div class="card-body">
                <h3 id="absent-count">{{ attendance_stats.absent }}</h3>
                <p>Absent</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-info text-white">
            <div class="card-body">
                <h3 id="total-count">{{ attendance_stats.total }}</h3>
                <p>Total</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <h3 id="percentage">{{ attendance_stats.percentage|floatformat:1 }}%</h3>
                <p>Attendance</p>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <input type="text" id="student-search" class="form-control" placeholder="Search students by name or roll number...">
            </div>
            <div class="col-md-3">
                <select id="status-filter" class="form-select">
                    <option value="">All Students</option>
                    <option value="PRESENT">Present Only</option>
                    <option value="ABSENT">Absent Only</option>
                    <option value="UNMARKED">Unmarked Only</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-primary w-100" onclick="exportAttendance()">Export to Excel</button>
            </div>
        </div>
    </div>
</div>

<!-- Attendance List -->
<div class="card">
    <div class="card-header">
        <h5>Student Attendance</h5>
    </div>
    <div class="card-body">
        <form id="attendance-form" method="post">
            {% csrf_token %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Roll Number</th>
                            <th>Student Name</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table">
                        {% for student in students %}
                        <tr data-student-id="{{ student.id }}" class="student-row">
                            <td>{{ student.roll_no }}</td>
                            <td>{{ student.get_full_name }}</td>
                            <td>{{ student.department.name|default:"N/A" }}</td>
                            <td>
                                {% with attendance_dict|get_item:student.id as student_attendance %}
                                <span class="badge attendance-badge 
                                    {% if student_attendance.status == 'PRESENT' %}bg-success
                                    {% elif student_attendance.status == 'ABSENT' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {% if student_attendance %}{{ student_attendance.get_status_display }}{% else %}Not Marked{% endif %}
                                </span>
                                {% endwith %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-success" 
                                            onclick="markAttendance({{ student.id }}, 'PRESENT')">Present</button>
                                    <button type="button" class="btn btn-sm btn-danger" 
                                            onclick="markAttendance({{ student.id }}, 'ABSENT')">Absent</button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No students found for this event</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<!-- Quick Actions -->
<div class="mt-4 text-center">
    <a href="{% url 'event_detail' event.id %}" class="btn btn-outline-primary">Back to Event</a>
    <button type="button" class="btn btn-primary" onclick="saveAttendance()">Save All Changes</button>
</div>

<script>
// Attendance tracking variables
let attendanceChanges = {};

function markAttendance(studentId, status) {
    attendanceChanges[studentId] = status;
    
    // Update UI immediately
    const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
    const badge = row.querySelector('.attendance-badge');
    
    badge.textContent = status === 'PRESENT' ? 'Present' : 'Absent';
    badge.className = `badge attendance-badge ${status === 'PRESENT' ? 'bg-success' : 'bg-danger'}`;
    
    updateStats();
}

function markAllPresent() {
    document.querySelectorAll('.student-row').forEach(row => {
        const studentId = row.getAttribute('data-student-id');
        markAttendance(parseInt(studentId), 'PRESENT');
    });
}

function markAllAbsent() {
    document.querySelectorAll('.student-row').forEach(row => {
        const studentId = row.getAttribute('data-student-id');
        markAttendance(parseInt(studentId), 'ABSENT');
    });
}

function updateStats() {
    let present = 0, absent = 0, total = 0;
    
    document.querySelectorAll('.attendance-badge').forEach(badge => {
        total++;
        if (badge.textContent === 'Present') present++;
        else if (badge.textContent === 'Absent') absent++;
    });
    
    document.getElementById('present-count').textContent = present;
    document.getElementById('absent-count').textContent = absent;
    document.getElementById('total-count').textContent = total;
    document.getElementById('percentage').textContent = total > 0 ? ((present / total) * 100).toFixed(1) + '%' : '0%';
}

function saveAttendance() {
    if (Object.keys(attendanceChanges).length === 0) {
        alert('No changes to save');
        return;
    }
    
    fetch(`/api/events/{{ event.id }}/attendance/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(attendanceChanges)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Attendance saved successfully!');
            attendanceChanges = {};
        } else {
            alert('Error saving attendance: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving attendance: ' + error);
    });
}

function exportAttendance() {
    window.location.href = `/events/{{ event.id }}/attendance/export/`;
}

// Search and filter functionality
document.getElementById('student-search').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    filterStudents();
});

document.getElementById('status-filter').addEventListener('change', function() {
    filterStudents();
});

function filterStudents() {
    const searchTerm = document.getElementById('student-search').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    
    document.querySelectorAll('.student-row').forEach(row => {
        const name = row.children[1].textContent.toLowerCase();
        const rollNo = row.children[0].textContent.toLowerCase();
        const status = row.querySelector('.attendance-badge').textContent;
        
        const matchesSearch = name.includes(searchTerm) || rollNo.includes(searchTerm);
        const matchesStatus = !statusFilter || 
                            (statusFilter === 'PRESENT' && status === 'Present') ||
                            (statusFilter === 'ABSENT' && status === 'Absent') ||
                            (statusFilter === 'UNMARKED' && status === 'Not Marked');
        
        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}
</script>
{% endblock %}