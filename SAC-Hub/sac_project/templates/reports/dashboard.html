{% extends 'base.html' %}

{% block title %}Reports Dashboard - SAC Hub{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Reports Dashboard</h2>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="exportReport('pdf')">
            <i class="bi bi-file-earmark-pdf"></i> Export PDF
        </button>
        <button type="button" class="btn btn-outline-success" onclick="exportReport('excel')">
            <i class="bi bi-file-earmark-excel"></i> Export Excel
        </button>
    </div>
</div>

<!-- Date Range Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" name="start_date" id="start_date" class="form-control" 
                       value="{{ request.GET.start_date|default:'' }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">End Date</label>
                <input type="date" name="end_date" id="end_date" class="form-control" 
                       value="{{ request.GET.end_date|default:'' }}">
            </div>
            <div class="col-md-3">
                <label for="club_filter" class="form-label">Club</label>
                <select name="club_filter" id="club_filter" class="form-select">
                    <option value="">All Clubs</option>
                    {% for club in clubs %}
                        <option value="{{ club.id }}" {% if request.GET.club_filter|stringformat:"s" == club.id|stringformat:"s" %}selected{% endif %}>
                            {{ club.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="{% url 'reports_dashboard' %}" class="btn btn-outline-secondary">Reset</a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <h3>{{ stats.total_events }}</h3>
                <p>Total Events</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <h3>{{ stats.total_participants }}</h3>
                <p>Total Participants</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-info text-white">
            <div class="card-body">
                <h3>{{ stats.active_clubs }}</h3>
                <p>Active Clubs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-warning text-white">
            <div class="card-body">
                <h3>{{ stats.avg_attendance|floatformat:1 }}%</h3>
                <p>Avg Attendance</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Events Over Time Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-graph-up"></i> Events Over Time</h5>
            </div>
            <div class="card-body">
                <canvas id="eventsChart" height="100"></canvas>
            </div>
        </div>

        <!-- Top Performing Clubs -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-trophy"></i> Top Performing Clubs</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Club</th>
                                <th>Events</th>
                                <th>Participants</th>
                                <th>Avg Attendance</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for club in top_clubs %}
                            <tr>
                                <td>
                                    {% if forloop.counter <= 3 %}
                                        <span class="badge bg-warning">{{ forloop.counter }}</span>
                                    {% else %}
                                        {{ forloop.counter }}
                                    {% endif %}
                                </td>
                                <td>{{ club.name }}</td>
                                <td>{{ club.events_count }}</td>
                                <td>{{ club.participants_count }}</td>
                                <td>{{ club.avg_attendance|floatformat:1 }}%</td>
                                <td>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ club.score }}%" 
                                             aria-valuenow="{{ club.score }}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                            {{ club.score|floatformat:0 }}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Events -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-calendar-event"></i> Recent Events</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Club</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Attendance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in recent_events %}
                            <tr>
                                <td>
                                    <a href="{% url 'event_detail' event.id %}">{{ event.name }}</a>
                                </td>
                                <td>{{ event.club.name }}</td>
                                <td>{{ event.date_time|date:"M d, Y" }}</td>
                                <td>
                                    <span class="badge bg-{{ event.status|lower }}">
                                        {{ event.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if event.attendance_rate %}
                                        {{ event.attendance_rate|floatformat:1 }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Event Status Distribution -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-pie-chart"></i> Event Status</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="200"></canvas>
            </div>
        </div>

        <!-- Attendance Trends -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-people"></i> Attendance Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="attendanceChart" height="200"></canvas>
            </div>
        </div>

        <!-- Department Participation -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-building"></i> Department Participation</h5>
            </div>
            <div class="card-body">
                {% for dept in department_stats %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ dept.name }}</span>
                        <div>
                            <span class="badge bg-primary">{{ dept.events_count }}</span>
                            <small class="text-muted">events</small>
                        </div>
                    </div>
                    <div class="progress mb-3" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ dept.participation_percentage }}%" 
                             aria-valuenow="{{ dept.participation_percentage }}" 
                             aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Events Over Time Chart
const eventsCtx = document.getElementById('eventsChart').getContext('2d');
new Chart(eventsCtx, {
    type: 'line',
    data: {
        labels: {{ events_timeline.labels|safe }},
        datasets: [{
            label: 'Events Created',
            data: {{ events_timeline.data|safe }},
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Event Status Pie Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: {{ status_distribution.labels|safe }},
        datasets: [{
            data: {{ status_distribution.data|safe }},
            backgroundColor: [
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#17a2b8',
                '#6c757d'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Attendance Trends Chart
const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
new Chart(attendanceCtx, {
    type: 'bar',
    data: {
        labels: {{ attendance_trends.labels|safe }},
        datasets: [{
            label: 'Attendance %',
            data: {{ attendance_trends.data|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});

function exportReport(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('format', format);
    window.location.href = `/reports/export/?${params.toString()}`;
}
</script>
{% endblock %}